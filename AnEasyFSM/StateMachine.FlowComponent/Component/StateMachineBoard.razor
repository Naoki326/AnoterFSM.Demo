@using StateMachine

@namespace StateMachine

<div class="sm-board">

    <div class="sm-nodes" style="flex: 0;">
        @if(nodeTypes is not null && nodeTypes.Count > 0)
        {
            <ul class="sm-node-list" style="list-style:none;padding:0;margin:0;">
                @foreach (var nodeType in nodeTypes)
                {
                    <li>
                        <div draggable="true"
                             class="@($"example-drawflow-node {nodeType.Value}")"
                             style="width:stretch;text-overflow:ellipsis;white-space:nowrap;overflow:hidden;"
                             @ondragstart="e => OnNodeDragStart(e, nodeType.Key)">
                            @nodeType.Key
                        </div>
                    </li>
                }
            </ul>
        }
    </div>

    <div style="flex: 1; position: relative;">
        <MStateMachineFlow Class="@Class" Style="@Style"
                   OnNodeSelected="@InnerNodeSelected"
                   OnNodeUnselected="@InnerNodeUnselected"
                   OnDrop="@DropAsync"
                   OnNodeCreated="@NodeCreated"
                   OnNodeRemoved="@NodeRemoved"
                   OnConnectionCreated="@ConnectionCreated"
                   OnConnectionRemoved="@ConnectionRemoved"
                   OnConnectionCancel="@ConnectionCancel"
                   OnConnectionDblClick="@ConnectionDblClick"
                   OnConnectionSelected="@ConnectionSelected"
                   OnConnectionUnselected="@OnConnectionUnselected"
                   OnNodeDblClick="@NodeDblClick"
                   OnNodeMoved="@NodeMoved"
                   Mode="Mode"
                   DataInitializer="@DataInitializer"
                   @ref="_drawflow">
        </MStateMachineFlow>
        
        @if (!string.IsNullOrEmpty(selectedNodeName))
        {
            <div style="position: absolute; top: 10px; left: 10px; z-index: 10000;">
                <button @onclick="@ShowNodeInfo" style="padding:6px 12px;border:1px solid #1976d2;background:#1976d2;color:#fff;border-radius:4px;">Node Info</button>
            </div>
        }
    </div>

</div>

@if (changeConnectionNameDialog)
{
    <div class="sm-dialog-backdrop" style="position:fixed;inset:0;background:rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;">
        <div class="sm-dialog" style="background:#fff;border-radius:8px;min-width:320px;max-width:500px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,0.2);">
            <div class="sm-dialog-title" style="font-weight:bold;margin-bottom:8px;">Set Connection Name</div>
            <div class="sm-dialog-body" style="margin-bottom:12px;">
                <input @bind="inputName" @onkeyup="OnCDKeyUp" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;" />
            </div>
            <div class="sm-dialog-actions" style="display:flex;gap:8px;justify-content:flex-end;">
                <button @onclick="ChangeConnectionName" style="padding:6px 12px;border:1px solid #1976d2;background:#1976d2;color:#fff;border-radius:4px;">Confirm</button>
                <button @onclick="CancelChangeConnectionName" style="padding:6px 12px;border:1px solid #ccc;background:#fff;border-radius:4px;">Cancel</button>
            </div>
        </div>
    </div>
}

@if (changeNodeNameDialog)
{
    <div class="sm-dialog-backdrop" style="position:fixed;inset:0;background:rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;">
        <div class="sm-dialog" style="background:#fff;border-radius:8px;min-width:320px;max-width:500px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,0.2);">
            <div class="sm-dialog-title" style="font-weight:bold;margin-bottom:8px;">Set Node Name</div>
            <div class="sm-dialog-body" style="margin-bottom:12px;">
                <input @bind="inputName" @onkeyup="OnNodeNameKeyUp" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;" />
            </div>
            <div class="sm-dialog-actions" style="display:flex;gap:8px;justify-content:flex-end;">
                <button @onclick="ChangeNodeName" style="padding:6px 12px;border:1px solid #1976d2;background:#1976d2;color:#fff;border-radius:4px;">Confirm</button>
                <button @onclick="CancelChangeNodeName" style="padding:6px 12px;border:1px solid #ccc;background:#fff;border-radius:4px;">Cancel</button>
            </div>
        </div>
    </div>
}

@if (nodeInfoDialog)
{
    <div class="sm-dialog-backdrop" style="position:fixed;inset:0;background:rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;">
        <div class="sm-dialog" style="background:#fff;border-radius:8px;min-width:360px;max-width:600px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,0.2);">
            <div class="sm-dialog-title" style="font-weight:bold;margin-bottom:8px;">Node Information</div>
            <div class="sm-dialog-body" style="margin-bottom:12px;">
                <div class="node-info-content">
                    <div class="info-row">
                        <strong>Node Name:</strong> @selectedNodeName
                    </div>
                    <div class="info-row">
                        <strong>File Path:</strong>
                        <div class="file-path">@selectedNodeFilePath</div>
                    </div>
                </div>
            </div>
            <div class="sm-dialog-actions" style="display:flex;gap:8px;justify-content:flex-end;">
                <button @onclick="CloseNodeInfoDialog" style="padding:6px 12px;border:1px solid #1976d2;background:#1976d2;color:#fff;border-radius:4px;">Close</button>
                <button @onclick="CopyFilePath" style="padding:6px 12px;border:1px solid #ccc;background:#fff;border-radius:4px;">Copy Path</button>
                <button @onclick="OpenInRider" style="padding:6px 12px;border:1px solid #ccc;background:#fff;border-radius:4px;">Open in Rider</button>
                <button @onclick="OpenInVSCode" style="padding:6px 12px;border:1px solid #ccc;background:#fff;border-radius:4px;">Open in VS Code</button>
            </div>
        </div>
    </div>
}

<style>
    .sm-board {
        display: flex;
        flex-direction: row;
    }

    .sm-nodes {
        display: flex;
        flex-direction: column;
    }

    /* just for DEMO */
    .example-drawflow-node {
        width: 120px;
        min-height: 40px;
        border-radius: 4px;
        padding: 15px;
        margin-right: 8px;
    }
    
    .node-info-content {
        padding: 16px 0;
    }
    
    .info-row {
        margin-bottom: 16px;
    }
    
    .info-row strong {
        display: inline-block;
        margin-bottom: 4px;
        color: #1976d2;
    }
    
    .file-path {
        background-color: #f5f5f5;
        padding: 8px 12px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 0.9em;
        word-break: break-all;
        border: 1px solid #e0e0e0;
        margin-top: 4px;
    }

    .sm-dialog-backdrop {
        z-index: 10000;
    }
</style>


